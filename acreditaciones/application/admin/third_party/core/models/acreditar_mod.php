<?phpif (!defined('BASEPATH'))    exit('No direct script access allowed');error_reporting(E_ALL ^ E_NOTICE);/** * @author Rodrigo Romero * @version 1.0.0 *  *  TODO: LOG */class acreditar_mod extends RR_Model {    private $search;    private $id;    public function __construct() {        parent::__construct();        $this->id = !empty($this->params['id']) ? $this->params['id'] : '';    }        public function getByKey() {        $this->search = filter_input(INPUT_POST, 'search');         $query = "SELECT a.*, c.gateway, c.nombre ticket, c.pago_status, c.empresa                  FROM acreditados a                  INNER JOIN (SELECT o.gateway, t.nombre, p.status pago_status, c.empresa, o.id                  FROM orders o                  INNER JOIN (SELECT * FROM tickets) t ON t.id = o.ticket_id                  INNER JOIN (SELECT * FROM pagos) p ON p.order_id = o.id                  INNER JOIN (SELECT * FROM customers) c ON c.id = o.customer_id                 ) c ON c.id = a.order_id                  WHERE a.evento_id =  $this->evento_id                  AND (a.nombre LIKE '%$this->search%' OR a.barcode = '%$this->search%' OR a.apellido LIKE '%$this->search%'                  OR c.empresa LIKE '%$this->search%' )";        $search = $this->db->query($query)->result();        $grid = $this->getGrid($search);        return array('success' => false, 'value' => $grid, 'responseType' => 'inject', 'inject' => 'j-module');    }        public function getById($i) {        $query = "SELECT a.*, c.gateway, c.nombre ticket, c.pago_status, c.empresa                  FROM acreditados a                  INNER JOIN (SELECT o.gateway, t.nombre, p.status pago_status, c.empresa, o.id                  FROM orders o                  INNER JOIN (SELECT * FROM tickets) t ON t.id = o.ticket_id                  INNER JOIN (SELECT * FROM pagos) p ON p.order_id = o.id                  INNER JOIN (SELECT * FROM customers) c ON c.id = o.customer_id                 ) c ON c.id = a.order_id                  WHERE a.evento_id =  $this->evento_id AND a.id = $i";        $search = $this->db->query($query)->row();        return $search;    }        public function getAll() {        $query = "SELECT a.*, c.gateway, c.nombre ticket, c.pago_status, c.empresa                  FROM acreditados a                  INNER JOIN (SELECT o.gateway, t.nombre, p.status pago_status, c.empresa, o.id                  FROM orders o                  INNER JOIN (SELECT * FROM tickets) t ON t.id = o.ticket_id                  INNER JOIN (SELECT * FROM pagos) p ON p.order_id = o.id                  INNER JOIN (SELECT * FROM customers) c ON c.id = o.customer_id                 ) c ON c.id = a.order_id                  WHERE a.`evento_id`  = ". $this->evento_id;        $acreditados = $this->db->query($query)->result();        return $acreditados;    }        public function getList() {        $data = $this->getAll();        return $this->getGrid($data);    }        public function getGrid($data) {        $grid = '<li class="tableHead hidden-xs hidden-sm row">        <div class="col-md-10">            <div class="row">                <div class="col-md-2">Empresa</div>                <div class="col-md-3">Nombre del participante</div>                <div class="col-md-2">Correo electr√≥nico</div>                <div class="col-md-2">Tipo de entrada</div>                <div class="col-md-2">Estado Pago</div>                            </div>        </div>                <div class="col-md-2">            <div>                Acreditar            </div>        </div>    </li>';        $template = <<<EOD<li class="item row">        <div class="col-xs-8 col-sm-9 col-md-10">            <div class="row">                <div class="name col-md-2">{empresa}</div>                <div class="name col-md-3"><a href="{link_acreditado}">{nombre_apellido}</a></div>                <div class="hidden-xs hidden-sm col-md-2"><a href="#" >{email}</a></div>                <div class="ticket col-md-2">{tipo_entrada}</div>                <div class="ticket col-md-2">{pago}</div>                <div class="detailBtn hidden-xs hidden-sm col-md-1"><a href="{link_acreditado}" >DETALLE</a></div>            </div>        </div>        <div class="switch col-xs-4 col-sm-3 col-md-2 text-right">            <a href="javascript:void(0)" class="{switchONOFF}" onClick="return false" data-link="{link}"></a>        </div>    </li>EOD;        $replace = array('{empresa}', '{nombre_apellido}', '{email}', '{tipo_entrada}', '{link_acreditado}', '{switchONOFF}', '{link}', '{pago}');        foreach ($data as $acreditado) {            $switchONOFF = ($acreditado->acreditado) ? 'switchON' : 'switchOFF';                        $data = array($acreditado->empresa,                           $acreditado->nombre . ' ' . $acreditado->apellido,                          $acreditado->email,                          $acreditado->ticket, lang_url('acreditar/detalle/id/'.$acreditado->id),                          $switchONOFF, lang_url('acreditar/alta/id/'.$acreditado->id),                          $acreditado->pago_status);            $grid .= str_replace($replace, $data, $template);        }        return $grid;    }        public function alta() {        if (!empty($this->id)) {            $values = array('acreditado' => 1);            $this->db->where('id', $this->id);            $query = $this->db->update('acreditados', $values);            if ($query) {                $success = true;                $responseType = 'function';                $function = 'reloadView';                $status = $this->view('alerts/generic', array('success' => 'Usuario Ingresado Exitosamente', 'type' => 'success'));                $list = $this->getList();                $data = array('success' => $success, 'responseType' => $responseType, 'value' => $function, "html" => $list, 'status' => $status, 'inject' => 'j-a');            }        }        return $data;    }        }